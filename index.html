<!DOCTYPE html>
<html lang="en">
<head>
<!--
==========================================================================
  MedScan Reconciliation PWA
  Version: 1.0.0
  
  SETUP INSTRUCTIONS:
  1. Open this file in any modern browser (Chrome/Safari/Firefox)
  2. On first launch, go to Settings (gear icon) and enter your 
     Anthropic API key (only needed for OCR fallback)
  3. For camera access, serve via HTTPS or localhost
     Quick option: python3 -m http.server 8080 â†’ open localhost:8080
  4. On mobile: share the file to your phone or host it on any 
     static hosting (Netlify Drop, GitHub Pages, etc.)
  
  LIBRARIES USED (loaded from CDN):
  - ZXing-js (QR/barcode decoding)
  - SheetJS xlsx.js (Excel parsing & export)
  
  DATA PRIVACY:
  - All data processed locally in the browser
  - No data sent to any server except Claude API for OCR (if used)
  - API key stored in sessionStorage only (cleared on tab close)
==========================================================================
-->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a1628">
<title>MedScan â€” Clinical Reconciliation</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0a1628;
    --surface: #111e35;
    --surface2: #162340;
    --border: #1e3055;
    --accent: #00d4ff;
    --accent2: #0099cc;
    --text: #e8f0fe;
    --text-muted: #6b8cba;
    --green: #00e5a0;
    --red: #ff4757;
    --yellow: #ffd32a;
    --orange: #ff6b35;
    --gray: #4a6280;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(0,212,255,0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(0,153,204,0.04) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .screen {
    display: none;
    flex-direction: column;
    min-height: 100vh;
    position: relative;
    z-index: 1;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .screen.active { display: flex; }

  /* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    padding-top: calc(16px + env(safe-area-inset-top));
    background: rgba(10,22,40,0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-mark {
    width: 32px;
    height: 32px;
    background: var(--accent);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-display);
    font-weight: 800;
    font-size: 14px;
    color: var(--bg);
    letter-spacing: -0.5px;
  }

  .logo-text {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 18px;
    letter-spacing: -0.3px;
    color: var(--text);
  }

  .logo-text span { color: var(--accent); }

  .header-actions { display: flex; gap: 8px; }

  .icon-btn {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 18px;
  }
  .icon-btn:hover, .icon-btn:active { background: var(--surface2); color: var(--accent); border-color: var(--accent); }

  /* â”€â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .content {
    flex: 1;
    padding: 24px 20px;
    max-width: 480px;
    margin: 0 auto;
    width: 100%;
  }

  /* â”€â”€â”€ TYPOGRAPHY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .screen-title {
    font-family: var(--font-display);
    font-weight: 800;
    font-size: 28px;
    letter-spacing: -0.5px;
    margin-bottom: 4px;
    line-height: 1.1;
  }

  .screen-subtitle {
    color: var(--text-muted);
    font-size: 13px;
    margin-bottom: 28px;
  }

  .section-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
    font-weight: 500;
  }

  /* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .field {
    margin-bottom: 16px;
  }

  .field label {
    display: block;
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .field input, .field select {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 15px;
    padding: 14px 16px;
    transition: all 0.2s;
    outline: none;
    -webkit-appearance: none;
  }

  .field input:focus, .field select:focus {
    border-color: var(--accent);
    background: var(--surface2);
    box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
  }

  .field input::placeholder { color: var(--text-muted); opacity: 0.5; }

  /* â”€â”€â”€ FILE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 28px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    background: var(--surface);
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent);
    background: rgba(0,212,255,0.05);
  }
  .upload-zone input {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 10;
  }
  .upload-zone .upload-icon { font-size: 32px; margin-bottom: 10px; }
  .upload-zone .upload-label {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 4px;
  }
  .upload-zone .upload-hint { font-size: 12px; color: var(--text-muted); }
  .upload-zone.loaded { border-color: var(--green); border-style: solid; }
  .upload-zone.loaded .upload-icon::after { content: 'âœ“'; }

  /* â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn {
    width: 100%;
    padding: 16px;
    border-radius: var(--radius);
    border: none;
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 16px;
    letter-spacing: 0.3px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: 54px;
  }

  .btn-primary {
    background: var(--accent);
    color: var(--bg);
  }
  .btn-primary:hover { background: #00eeff; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,212,255,0.3); }
  .btn-primary:active { transform: translateY(0); }

  .btn-secondary {
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .btn-danger {
    background: rgba(255,71,87,0.15);
    color: var(--red);
    border: 1px solid rgba(255,71,87,0.3);
  }

  .btn-success {
    background: var(--green);
    color: var(--bg);
  }
  .btn-success:hover { background: #00ffb3; }

  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

  .btn-row { display: flex; gap: 10px; margin-top: 8px; }
  .btn-row .btn { flex: 1; }

  /* â”€â”€â”€ STATS STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-strip {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    margin: 16px 0;
    padding: 0 20px;
  }

  .stat-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 6px;
    text-align: center;
  }

  .stat-chip .stat-val {
    font-family: var(--font-display);
    font-weight: 800;
    font-size: 20px;
    line-height: 1;
    margin-bottom: 2px;
  }

  .stat-chip .stat-lbl {
    font-size: 8px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .stat-chip.ok .stat-val { color: var(--green); }
  .stat-chip.dup .stat-val { color: var(--yellow); }
  .stat-chip.unauth .stat-val { color: var(--red); }
  .stat-chip.exp .stat-val { color: var(--orange); }
  .stat-chip.total .stat-val { color: var(--accent); }

  /* â”€â”€â”€ CAMERA SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .camera-wrap {
    position: relative;
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
    aspect-ratio: 4/3;
    margin-bottom: 16px;
  }

  #video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .scan-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .scan-frame {
    width: 65%;
    aspect-ratio: 1;
    position: relative;
  }

  .scan-frame::before, .scan-frame::after,
  .scan-frame > span::before, .scan-frame > span::after {
    content: '';
    position: absolute;
    width: 24px;
    height: 24px;
    border-color: var(--accent);
    border-style: solid;
  }
  .scan-frame::before { top: 0; left: 0; border-width: 3px 0 0 3px; }
  .scan-frame::after { top: 0; right: 0; border-width: 3px 3px 0 0; }
  .scan-frame > span::before { bottom: 0; left: 0; border-width: 0 0 3px 3px; }
  .scan-frame > span::after { bottom: 0; right: 0; border-width: 0 3px 3px 0; }

  .scan-line {
    position: absolute;
    left: 10%;
    right: 10%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scanline 2s ease-in-out infinite;
    box-shadow: 0 0 8px var(--accent);
  }

  @keyframes scanline {
    0% { top: 10%; opacity: 1; }
    50% { top: 90%; opacity: 0.8; }
    100% { top: 10%; opacity: 1; }
  }

  .scan-status {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    color: var(--accent);
    white-space: nowrap;
    border: 1px solid rgba(0,212,255,0.3);
  }

  /* â”€â”€â”€ CAPTURE TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .capture-tabs {
    display: flex;
    background: var(--surface);
    border-radius: var(--radius-sm);
    padding: 4px;
    margin-bottom: 14px;
    border: 1px solid var(--border);
  }

  .capture-tab {
    flex: 1;
    padding: 10px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .capture-tab.active {
    background: var(--accent);
    color: var(--bg);
    font-weight: 500;
  }

  /* â”€â”€â”€ PREVIEW CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .preview-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
    display: none;
  }

  .preview-card.show { display: block; }
  .preview-card .preview-title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
  }

  .preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 14px;
  }

  .preview-field {
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
  }

  .preview-field .pf-label {
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .preview-field input {
    background: transparent;
    border: none;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 500;
    width: 100%;
    outline: none;
    padding: 0;
  }

  /* â”€â”€â”€ VALIDATION BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .validation-banner {
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 14px;
    display: none;
    align-items: center;
    gap: 10px;
  }
  .validation-banner.show { display: flex; }
  .validation-banner.authorized { background: rgba(0,229,160,0.15); border: 1px solid rgba(0,229,160,0.3); color: var(--green); }
  .validation-banner.duplicate { background: rgba(255,211,42,0.15); border: 1px solid rgba(255,211,42,0.3); color: var(--yellow); }
  .validation-banner.unauthorized { background: rgba(255,71,87,0.15); border: 1px solid rgba(255,71,87,0.3); color: var(--red); }
  .validation-banner.expired { background: rgba(255,107,53,0.15); border: 1px solid rgba(255,107,53,0.3); color: var(--orange); }

  /* â”€â”€â”€ SCANNED LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .scan-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .scan-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .scan-item.authorized { border-left: 3px solid var(--green); }
  .scan-item.duplicate { border-left: 3px solid var(--yellow); }
  .scan-item.unauthorized { border-left: 3px solid var(--red); }
  .scan-item.expired { border-left: 3px solid var(--orange); }

  .scan-item-status {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
  }
  .scan-item.authorized .scan-item-status { background: rgba(0,229,160,0.15); }
  .scan-item.duplicate .scan-item-status { background: rgba(255,211,42,0.15); }
  .scan-item.unauthorized .scan-item-status { background: rgba(255,71,87,0.15); }
  .scan-item.expired .scan-item-status { background: rgba(255,107,53,0.15); }

  .scan-item-info { flex: 1; min-width: 0; }
  .scan-item-sn {
    font-weight: 500;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .scan-item-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

  .scan-item-del {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .scan-item-del:hover { color: var(--red); }

  /* â”€â”€â”€ SUMMARY TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-bottom: 20px;
  }

  .summary-table th {
    text-align: left;
    padding: 8px 10px;
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
  }

  .summary-table td {
    padding: 10px 10px;
    border-bottom: 1px solid rgba(30,48,85,0.5);
    vertical-align: middle;
  }

  .summary-table tr.authorized td { border-left: 2px solid var(--green); }
  .summary-table tr.duplicate td { border-left: 2px solid var(--yellow); background: rgba(255,211,42,0.03); }
  .summary-table tr.unauthorized td { border-left: 2px solid var(--red); background: rgba(255,71,87,0.03); }
  .summary-table tr.expired td { border-left: 2px solid var(--orange); background: rgba(255,107,53,0.05); }
  .summary-table tr.missing td { border-left: 2px solid var(--gray); background: rgba(74,98,128,0.05); color: var(--text-muted); }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 500;
    white-space: nowrap;
  }
  .status-badge.authorized { background: rgba(0,229,160,0.15); color: var(--green); }
  .status-badge.duplicate { background: rgba(255,211,42,0.15); color: var(--yellow); }
  .status-badge.unauthorized { background: rgba(255,71,87,0.15); color: var(--red); }
  .status-badge.expired { background: rgba(255,107,53,0.15); color: var(--orange); }
  .status-badge.missing { background: rgba(74,98,128,0.15); color: var(--gray); }

  /* â”€â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(10,22,40,0.85);
    backdrop-filter: blur(8px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    display: none;
  }
  .loading-overlay.show { display: flex; }

  .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-msg {
    font-size: 14px;
    color: var(--text-muted);
  }

  /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: calc(24px + env(safe-area-inset-bottom));
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 12px 20px;
    font-size: 14px;
    z-index: 2000;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    white-space: nowrap;
    max-width: 90vw;
    text-align: center;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .settings-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }

  .settings-section h3 {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 4px;
  }

  .settings-section p {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 16px;
    line-height: 1.5;
  }

  /* â”€â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-wrap {
    background: var(--surface);
    border-radius: 4px;
    height: 4px;
    overflow: hidden;
    margin: 8px 20px;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 4px;
    transition: width 0.4s ease;
    width: 0%;
  }

  /* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }
  .empty-state .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
  .empty-state p { font-size: 13px; line-height: 1.6; }

  /* â”€â”€â”€ SESSION INFO CHIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .session-info-bar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 8px 20px;
    display: flex;
    gap: 16px;
    font-size: 11px;
    color: var(--text-muted);
    overflow-x: auto;
    white-space: nowrap;
  }
  .session-info-bar span b { color: var(--text); }

  /* â”€â”€â”€ MANUAL ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .manual-form {
    display: none;
  }
  .manual-form.show { display: block; }
  .manual-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 14px;
  }

  /* â”€â”€â”€ ALERT STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .alert-strip {
    background: rgba(0,212,255,0.08);
    border: 1px solid rgba(0,212,255,0.2);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-size: 12px;
    color: var(--accent);
    margin-bottom: 16px;
    display: flex;
    gap: 8px;
    align-items: flex-start;
    line-height: 1.5;
  }

  /* scrollable list area */
  .scan-list-wrap {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px;
  }

  /* â”€â”€â”€ MISSING TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .missing-count {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(74,98,128,0.15);
    border: 1px solid var(--gray);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 16px;
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1: SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-settings">
  <div class="header">
    <div class="logo">
      <div class="logo-mark">M</div>
      <div class="logo-text">Med<span>Scan</span></div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="showScreen('screen-setup')" title="Back">âœ•</button>
    </div>
  </div>
  <div class="content">
    <p class="screen-title">Settings</p>
    <p class="screen-subtitle">Configure your scanning preferences</p>

    <div class="settings-section">
      <h3>ğŸ”‘ Anthropic API Key</h3>
      <p>Required only for OCR fallback when QR codes are unreadable. Stored in sessionStorage only â€” cleared when you close the tab.</p>
      <div class="field">
        <label>API Key</label>
        <input type="password" id="api-key-input" placeholder="sk-ant-..." autocomplete="off">
      </div>
      <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
    </div>

    <div class="settings-section">
      <h3>ğŸ“‹ About MedScan</h3>
      <p>Version 1.0.0 â€” Clinical medication reconciliation tool for CRAs. All data is processed locally in your browser. No patient data is transmitted to external servers (except Claude API for OCR, if used).</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2: SESSION SETUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-setup">
  <div class="header">
    <div class="logo">
      <div class="logo-mark">M</div>
      <div class="logo-text">Med<span>Scan</span></div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="showScreen('screen-settings')" title="Settings">âš™</button>
    </div>
  </div>
  <div class="content">
    <p class="screen-title">New Session</p>
    <p class="screen-subtitle">Configure this reconciliation visit</p>

    <p class="section-label">Site Information</p>
    <div class="field">
      <label>Site Name</label>
      <input type="text" id="site-name" placeholder="e.g. Hospital Italiano â€” Buenos Aires">
    </div>
    <div class="field">
      <label>Protocol / Study ID</label>
      <input type="text" id="protocol-id" placeholder="e.g. TRIAL-2024-001">
    </div>
    <div class="field">
      <label>CRA Name</label>
      <input type="text" id="cra-name" placeholder="Your full name">
    </div>
    <div class="field">
      <label>Visit Date</label>
      <input type="date" id="visit-date">
    </div>

    <p class="section-label" style="margin-top: 8px;">IWRS Master List</p>
    <div class="alert-strip">
      <span>â„¹</span>
      <span>Upload the IWRS export file (.xlsx or .csv). The system will use it to validate each scanned product in real time.</span>
    </div>
    <div class="upload-zone" id="upload-zone">
      <input type="file" id="iwrs-file" accept=".xlsx,.csv,.xls" onchange="handleIWRSUpload(event)">
      <div class="upload-icon">ğŸ“‚</div>
      <div class="upload-label" id="upload-label">Upload IWRS File</div>
      <div class="upload-hint" id="upload-hint">Tap to select Â· .xlsx or .csv</div>
    </div>

    <div style="margin-top: 24px;">
      <button class="btn btn-primary" id="start-scan-btn" onclick="startSession()" disabled>
        Start Scanning â†’
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3: SCANNING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-scan">
  <div class="header">
    <div class="logo">
      <div class="logo-mark">M</div>
      <div class="logo-text">Med<span>Scan</span></div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="endSession()" title="Finish">â—¼</button>
      <button class="icon-btn" onclick="showScreen('screen-settings')" title="Settings">âš™</button>
    </div>
  </div>

  <div class="session-info-bar" id="session-info-bar">
    <span><b id="si-site">â€”</b></span>
    <span>Protocol: <b id="si-protocol">â€”</b></span>
    <span>Date: <b id="si-date">â€”</b></span>
    <span>CRA: <b id="si-cra">â€”</b></span>
  </div>

  <div class="stats-strip">
    <div class="stat-chip total">
      <div class="stat-val" id="stat-total">0</div>
      <div class="stat-lbl">Total</div>
    </div>
    <div class="stat-chip ok">
      <div class="stat-val" id="stat-ok">0</div>
      <div class="stat-lbl">Auth</div>
    </div>
    <div class="stat-chip dup">
      <div class="stat-val" id="stat-dup">0</div>
      <div class="stat-lbl">Dup</div>
    </div>
    <div class="stat-chip unauth">
      <div class="stat-val" id="stat-unauth">0</div>
      <div class="stat-lbl">Unauth</div>
    </div>
    <div class="stat-chip exp">
      <div class="stat-val" id="stat-exp">0</div>
      <div class="stat-lbl">Exp</div>
    </div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <div style="padding: 0 20px 0; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
    <!-- Capture mode tabs -->
    <div class="capture-tabs" style="margin-top: 14px;">
      <button class="capture-tab active" id="tab-qr" onclick="switchTab('qr')">ğŸ“· QR / Barcode</button>
      <button class="capture-tab" id="tab-ocr" onclick="switchTab('ocr')">ğŸ” OCR (Camera)</button>
      <button class="capture-tab" id="tab-manual" onclick="switchTab('manual')">âœ Manual</button>
    </div>

    <!-- QR Tab -->
    <div id="panel-qr">
      <div class="camera-wrap">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-overlay">
          <div class="scan-frame">
            <span></span>
            <div class="scan-line"></div>
          </div>
        </div>
        <div class="scan-status" id="scan-status">Searching for code...</div>
      </div>
    </div>

    <!-- OCR Tab -->
    <div id="panel-ocr" style="display:none;">
      <div class="camera-wrap">
        <video id="video-ocr" autoplay playsinline muted></video>
        <div class="scan-overlay">
          <div class="scan-frame"><span></span></div>
        </div>
        <div class="scan-status">Position label Â· Tap capture</div>
      </div>
      <button class="btn btn-secondary" style="margin-bottom: 12px;" onclick="captureOCR()">ğŸ“¸ Capture & Extract</button>
      <canvas id="canvas-ocr" style="display:none;"></canvas>
    </div>

    <!-- Manual Tab -->
    <div id="panel-manual" style="display:none;">
      <div class="manual-grid">
        <div class="field" style="margin-bottom:0;">
          <label>REF</label>
          <input type="text" id="m-ref" placeholder="EFC17919" style="text-transform:uppercase;">
        </div>
        <div class="field" style="margin-bottom:0;">
          <label>SN</label>
          <input type="text" id="m-sn" placeholder="0268366">
        </div>
        <div class="field" style="margin-bottom:0;">
          <label>PSU</label>
          <input type="text" id="m-psu" placeholder="59133">
        </div>
        <div class="field" style="margin-bottom:0;">
          <label>LOT</label>
          <input type="text" id="m-lot" placeholder="IP041184">
        </div>
        <div class="field" style="margin-bottom:0; grid-column: 1/-1;">
          <label>EXP (MM-YYYY)</label>
          <input type="text" id="m-exp" placeholder="10-2026">
        </div>
      </div>
      <button class="btn btn-primary" onclick="submitManual()">Add Product</button>
    </div>

    <!-- Preview Card -->
    <div class="preview-card" id="preview-card">
      <div class="preview-title">ğŸ“‹ Confirm Extracted Data</div>
      <div class="preview-grid">
        <div class="preview-field">
          <div class="pf-label">REF</div>
          <input type="text" id="p-ref">
        </div>
        <div class="preview-field">
          <div class="pf-label">SN</div>
          <input type="text" id="p-sn">
        </div>
        <div class="preview-field">
          <div class="pf-label">PSU</div>
          <input type="text" id="p-psu">
        </div>
        <div class="preview-field">
          <div class="pf-label">LOT</div>
          <input type="text" id="p-lot">
        </div>
        <div class="preview-field" style="grid-column: 1/-1;">
          <div class="pf-label">EXP</div>
          <input type="text" id="p-exp">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="dismissPreview()">âœ• Discard</button>
        <button class="btn btn-primary" onclick="confirmProduct()">âœ“ Confirm</button>
      </div>
    </div>

    <!-- Validation Banner -->
    <div class="validation-banner" id="validation-banner"></div>

    <!-- Scanned list (scrollable) -->
    <div style="flex:1; overflow-y:auto; padding-bottom: 16px; margin: 0 -0px;">
      <div class="scan-list" id="scan-list">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“¦</div>
          <p>No products scanned yet.<br>Point the camera at a label or QR code.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4: SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-summary">
  <div class="header">
    <div class="logo">
      <div class="logo-mark">M</div>
      <div class="logo-text">Med<span>Scan</span></div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="newSession()" title="New Session">+</button>
    </div>
  </div>
  <div class="content" style="overflow-y: auto; padding-bottom: 100px;">
    <p class="screen-title">Reconciliation<br>Report</p>
    <p class="screen-subtitle" id="sum-subtitle">Session complete</p>

    <div class="stats-strip" style="padding: 0; margin-bottom: 20px;">
      <div class="stat-chip total">
        <div class="stat-val" id="sum-total">0</div>
        <div class="stat-lbl">Total</div>
      </div>
      <div class="stat-chip ok">
        <div class="stat-val" id="sum-ok">0</div>
        <div class="stat-lbl">Auth</div>
      </div>
      <div class="stat-chip dup">
        <div class="stat-val" id="sum-dup">0</div>
        <div class="stat-lbl">Dup</div>
      </div>
      <div class="stat-chip unauth">
        <div class="stat-val" id="sum-unauth">0</div>
        <div class="stat-lbl">Unauth</div>
      </div>
      <div class="stat-chip exp">
        <div class="stat-val" id="sum-exp">0</div>
        <div class="stat-lbl">Exp</div>
      </div>
    </div>

    <p class="section-label">Scanned Products</p>
    <div style="overflow-x: auto; margin-bottom: 20px; border-radius: var(--radius); border: 1px solid var(--border);">
      <table class="summary-table" id="sum-table">
        <thead>
          <tr>
            <th>#</th>
            <th>SN</th>
            <th>REF</th>
            <th>LOT</th>
            <th>EXP</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="sum-tbody"></tbody>
      </table>
    </div>

    <div id="missing-section" style="display:none;">
      <p class="section-label">Not Scanned (In IWRS)</p>
      <div class="missing-count" id="missing-count-badge">0 items not returned</div>
      <div style="overflow-x: auto; margin-bottom: 20px; border-radius: var(--radius); border: 1px solid var(--border);">
        <table class="summary-table" id="missing-table">
          <thead>
            <tr><th>SN</th><th>REF</th><th>LOT</th><th>EXP</th><th>Status</th></tr>
          </thead>
          <tbody id="missing-tbody"></tbody>
        </table>
      </div>
    </div>

    <button class="btn btn-success" onclick="exportExcel()" style="margin-bottom: 10px;">
      â¬‡ Export to Excel
    </button>
    <button class="btn btn-secondary" onclick="newSession()">
      + New Session
    </button>
  </div>
</div>

<!-- â”€â”€â”€ LOADING OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-msg" id="loading-msg">Processing...</div>
</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  session: null,
  scanned: [],          // array of product objects
  iwrs: new Map(),      // SN â†’ row data (from IWRS file)
  iwrsRaw: [],          // raw array of IWRS rows
  videoStream: null,
  codeReader: null,
  ocrStream: null,
  activeTab: 'qr',
  scanning: false,
};

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('visit-date').valueAsDate = new Date();
  const savedKey = sessionStorage.getItem('anthropic_key');
  if (savedKey) document.getElementById('api-key-input').value = savedKey;

  // Enable start button when required fields are filled
  ['site-name', 'cra-name', 'visit-date'].forEach(id => {
    document.getElementById(id).addEventListener('input', checkSetupReady);
  });
});

function checkSetupReady() {
  const site = document.getElementById('site-name').value.trim();
  const cra = document.getElementById('cra-name').value.trim();
  const date = document.getElementById('visit-date').value;
  const iwrsLoaded = state.iwrs.size > 0;
  document.getElementById('start-scan-btn').disabled = !(site && cra && date && iwrsLoaded);
}

// â”€â”€â”€ SCREEN NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  if (id !== 'screen-scan') {
    stopCamera();
  }
  if (id === 'screen-scan' && state.activeTab === 'qr') {
    startQRCamera();
  }
}

// â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) { toast('Please enter an API key'); return; }
  sessionStorage.setItem('anthropic_key', key);
  toast('âœ“ API key saved for this session');
  showScreen('screen-setup');
}

// â”€â”€â”€ IWRS UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleIWRSUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  showLoading('Parsing IWRS file...');
  try {
    const data = await file.arrayBuffer();
    let rows = [];

    if (file.name.toLowerCase().endsWith('.csv')) {
      const text = new TextDecoder().decode(data);
      rows = parseCSV(text);
    } else {
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    }

    // Build IWRS map â€” try to find SN column (flexible column names)
    state.iwrs.clear();
    state.iwrsRaw = rows;

    const snKeys = ['SN', 'sn', 'Serial Number', 'SerialNumber', 'serial_number', 'SERIAL_NUMBER'];
    let snKey = null;
    if (rows.length > 0) {
      const firstRow = rows[0];
      snKey = snKeys.find(k => k in firstRow) || Object.keys(firstRow)[1] || Object.keys(firstRow)[0];
    }

    rows.forEach(row => {
      const sn = String(row[snKey] || '').trim();
      if (sn) state.iwrs.set(sn, row);
    });

    hideLoading();

    if (state.iwrs.size === 0) {
      toast('âš  No SN data found. Check column headers.');
    } else {
      document.getElementById('upload-zone').classList.add('loaded');
      document.getElementById('upload-icon') && (document.getElementById('upload-icon').textContent = 'âœ…');
      document.getElementById('upload-label').textContent = `âœ… ${file.name}`;
      document.getElementById('upload-hint').textContent = `${state.iwrs.size} products loaded from IWRS`;
      checkSetupReady();
      toast(`âœ“ ${state.iwrs.size} products loaded`);
    }

  } catch (err) {
    hideLoading();
    toast('Error parsing file: ' + err.message);
    console.error(err);
  }
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
  return lines.slice(1).map(line => {
    const vals = line.split(',').map(v => v.trim().replace(/"/g, ''));
    const obj = {};
    headers.forEach((h, i) => obj[h] = vals[i] || '');
    return obj;
  });
}

// â”€â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startSession() {
  const site = document.getElementById('site-name').value.trim();
  const protocol = document.getElementById('protocol-id').value.trim();
  const cra = document.getElementById('cra-name').value.trim();
  const date = document.getElementById('visit-date').value;

  state.session = { site, protocol, cra, date };
  state.scanned = [];

  // Update info bar
  document.getElementById('si-site').textContent = site;
  document.getElementById('si-protocol').textContent = protocol || 'â€”';
  document.getElementById('si-date').textContent = date;
  document.getElementById('si-cra').textContent = cra;

  updateStats();
  renderScanList();
  showScreen('screen-scan');
}

function endSession() {
  stopCamera();
  buildSummary();
  showScreen('screen-summary');
}

function newSession() {
  state.scanned = [];
  state.iwrs.clear();
  state.iwrsRaw = [];
  state.session = null;

  document.getElementById('upload-zone').classList.remove('loaded');
  document.getElementById('upload-label').textContent = 'Upload IWRS File';
  document.getElementById('upload-hint').textContent = 'Tap to select Â· .xlsx or .csv';
  document.getElementById('iwrs-file').value = '';
  document.getElementById('start-scan-btn').disabled = true;

  showScreen('screen-setup');
}

// â”€â”€â”€ CAMERA / QR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startQRCamera() {
  if (state.scanning) return;

  const video = document.getElementById('video');
  const statusEl = document.getElementById('scan-status');

  statusEl.textContent = 'Starting camera...';

  try {
    // Stop any existing stream first
    if (state.videoStream) {
      state.videoStream.getTracks().forEach(t => t.stop());
      state.videoStream = null;
    }

    // Try rear camera first, fall back to any camera
    let stream;
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } }
      });
    } catch (e) {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
    }

    state.videoStream = stream;
    video.srcObject = stream;

    await new Promise((resolve, reject) => {
      video.onloadedmetadata = resolve;
      video.onerror = reject;
      setTimeout(reject, 5000); // timeout fallback
    });

    await video.play();
    state.scanning = true;
    statusEl.textContent = 'Searching for code...';

    // Start ZXing scanning loop
    const codeReader = new ZXing.BrowserMultiFormatReader();
    state.codeReader = codeReader;

    codeReader.decodeFromStream(stream, video, (result, err) => {
      if (result) handleQRResult(result.getText());
    });

  } catch (err) {
    state.scanning = false;
    console.error('Camera error:', err);

    let msg = 'Camera unavailable';
    if (err.name === 'NotAllowedError') msg = 'Camera permission denied â€” allow access in browser settings';
    else if (err.name === 'NotFoundError') msg = 'No camera found on this device';
    else if (err.name === 'NotReadableError') msg = 'Camera in use by another app';

    statusEl.textContent = msg;
    toast('âš  ' + msg);
  }
}

function stopCamera() {
  if (state.codeReader) {
    try { state.codeReader.reset(); } catch(e) {}
    state.codeReader = null;
  }
  if (state.videoStream) {
    state.videoStream.getTracks().forEach(t => t.stop());
    state.videoStream = null;
  }
  if (state.ocrStream) {
    state.ocrStream.getTracks().forEach(t => t.stop());
    state.ocrStream = null;
  }
  state.scanning = false;
}

// â”€â”€â”€ QR RESULT PARSING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastQRText = '';
let lastQRTime = 0;

function handleQRResult(text) {
  const now = Date.now();
  if (text === lastQRText && now - lastQRTime < 3000) return; // debounce
  lastQRText = text;
  lastQRTime = now;

  document.getElementById('scan-status').textContent = 'âœ“ Code detected!';
  setTimeout(() => {
    if (document.getElementById('scan-status'))
      document.getElementById('scan-status').textContent = 'Searching for code...';
  }, 1500);

  // Try to parse structured data
  const product = parseQRData(text);
  showPreview(product);
  vibrate();
}

function parseQRData(text) {
  // Try JSON
  try {
    const parsed = JSON.parse(text);
    return normalize(parsed);
  } catch {}

  // Try key=value pairs (common GS1/datamatrix)
  const product = {};
  const patterns = {
    ref: /(?:REF|ref)[:\s=]+([A-Za-z0-9]+)/i,
    sn:  /(?:SN|S\/N|serial)[:\s=]+([A-Za-z0-9]+)/i,
    psu: /(?:PSU)[:\s=]+([A-Za-z0-9]+)/i,
    lot: /(?:LOT|lot)[:\s=]+([A-Za-z0-9]+)/i,
    exp: /(?:EXP|exp|expiry)[:\s=]+(\d{2}[-\/]\d{4}|\d{4}[-\/]\d{2})/i,
  };
  let found = false;
  Object.entries(patterns).forEach(([key, re]) => {
    const m = text.match(re);
    if (m) { product[key] = m[1]; found = true; }
  });

  // If no structured data, treat whole text as SN fallback
  if (!found) {
    const clean = text.trim().replace(/\s+/g, '');
    product.sn = clean;
  }

  return product;
}

function normalize(obj) {
  const map = {
    ref: ['REF', 'ref', 'reference', 'Reference'],
    sn:  ['SN', 'sn', 'serial', 'serialNumber', 'SerialNumber'],
    psu: ['PSU', 'psu'],
    lot: ['LOT', 'lot', 'Lot', 'LotNumber', 'lotNumber'],
    exp: ['EXP', 'exp', 'expiry', 'Expiry', 'expirationDate'],
  };
  const result = {};
  Object.entries(map).forEach(([key, aliases]) => {
    for (const alias of aliases) {
      if (obj[alias] !== undefined) { result[key] = String(obj[alias]); break; }
    }
  });
  return result;
}

// â”€â”€â”€ OCR TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startOCRCamera() {
  const video = document.getElementById('video-ocr');
  try {
    if (state.ocrStream) {
      state.ocrStream.getTracks().forEach(t => t.stop());
      state.ocrStream = null;
    }
    let stream;
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } }
      });
    } catch(e) {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
    }
    state.ocrStream = stream;
    video.srcObject = stream;
    await video.play();
  } catch(err) {
    console.error(err);
    toast('Camera error: ' + (err.name === 'NotAllowedError' ? 'Permission denied' : err.message));
  }
}

async function captureOCR() {
  const video = document.getElementById('video-ocr');
  const canvas = document.getElementById('canvas-ocr');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const imageData = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];

  const apiKey = sessionStorage.getItem('anthropic_key');
  if (!apiKey) {
    toast('API key required for OCR. Go to Settings.');
    return;
  }

  showLoading('Extracting label data via AI...');

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 300,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: { type: 'base64', media_type: 'image/jpeg', data: imageData }
            },
            {
              type: 'text',
              text: 'Extract the following fields from this medication label image and return ONLY a valid JSON object with no extra text: {"ref": "", "sn": "", "psu": "", "lot": "", "exp": ""}. If a field is not visible, use null. The EXP field format is MM-YYYY.'
            }
          ]
        }]
      })
    });

    const data = await response.json();
    hideLoading();

    if (data.content && data.content[0]) {
      let text = data.content[0].text.trim();
      // Remove markdown code blocks if present
      text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
      const product = JSON.parse(text);
      showPreview(normalize(product));
      vibrate();
    } else {
      toast('OCR failed. Try again or use manual entry.');
    }

  } catch (err) {
    hideLoading();
    console.error(err);
    toast('OCR error: ' + err.message);
  }
}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  state.activeTab = tab;
  ['qr', 'ocr', 'manual'].forEach(t => {
    document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    document.getElementById(`panel-${t}`).style.display = t === tab ? 'block' : 'none';
  });

  if (tab === 'qr') {
    if (state.ocrStream) { state.ocrStream.getTracks().forEach(t => t.stop()); state.ocrStream = null; }
    startQRCamera();
  } else if (tab === 'ocr') {
    if (state.codeReader) { try { state.codeReader.reset(); } catch(e) {} state.codeReader = null; }
    if (state.videoStream) { state.videoStream.getTracks().forEach(t => t.stop()); state.videoStream = null; }
    state.scanning = false;
    startOCRCamera();
  } else {
    stopCamera();
  }

  dismissPreview();
}

// â”€â”€â”€ PREVIEW & CONFIRM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPreview(product) {
  document.getElementById('p-ref').value = product.ref || '';
  document.getElementById('p-sn').value = product.sn || '';
  document.getElementById('p-psu').value = product.psu || '';
  document.getElementById('p-lot').value = product.lot || '';
  document.getElementById('p-exp').value = product.exp || '';
  document.getElementById('preview-card').classList.add('show');
  hideValidationBanner();
}

function dismissPreview() {
  document.getElementById('preview-card').classList.remove('show');
  hideValidationBanner();
}

function confirmProduct() {
  const product = {
    ref: document.getElementById('p-ref').value.trim().toUpperCase(),
    sn:  document.getElementById('p-sn').value.trim(),
    psu: document.getElementById('p-psu').value.trim(),
    lot: document.getElementById('p-lot').value.trim().toUpperCase(),
    exp: document.getElementById('p-exp').value.trim(),
    timestamp: new Date().toISOString(),
  };

  if (!product.sn) { toast('SN is required'); return; }
  addProduct(product);
  dismissPreview();
}

function submitManual() {
  const product = {
    ref: document.getElementById('m-ref').value.trim().toUpperCase(),
    sn:  document.getElementById('m-sn').value.trim(),
    psu: document.getElementById('m-psu').value.trim(),
    lot: document.getElementById('m-lot').value.trim().toUpperCase(),
    exp: document.getElementById('m-exp').value.trim(),
    timestamp: new Date().toISOString(),
  };

  if (!product.sn) { toast('SN is required'); return; }
  addProduct(product);

  // Clear manual fields
  ['m-ref', 'm-sn', 'm-psu', 'm-lot', 'm-exp'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('m-sn').focus();
}

// â”€â”€â”€ VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addProduct(product) {
  // Validate
  const status = validateProduct(product);
  product.status = status;

  state.scanned.push(product);
  updateStats();
  renderScanList();
  showValidationBanner(status, product);
  updateProgress();
  vibrate();
}

function validateProduct(product) {
  const sn = product.sn;

  // Check duplicate first
  const prevScanned = state.scanned.find(p => p.sn === sn);
  if (prevScanned) return 'duplicate';

  // Check if authorized
  const inIWRS = state.iwrs.has(sn);

  // Check expiration
  const expired = isExpired(product.exp);

  if (expired) return 'expired';
  if (!inIWRS) return 'unauthorized';
  return 'authorized';
}

function isExpired(expStr) {
  if (!expStr) return false;
  try {
    const parts = expStr.split(/[-\/]/);
    let month, year;
    if (parts[0].length === 4) { year = parseInt(parts[0]); month = parseInt(parts[1]); }
    else { month = parseInt(parts[0]); year = parseInt(parts[1]); }
    if (isNaN(month) || isNaN(year)) return false;
    const expDate = new Date(year, month, 0); // last day of month
    return expDate < new Date();
  } catch { return false; }
}

// â”€â”€â”€ STATS & UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const counts = { total: state.scanned.length, authorized: 0, duplicate: 0, unauthorized: 0, expired: 0 };
  state.scanned.forEach(p => {
    if (counts[p.status] !== undefined) counts[p.status]++;
  });
  document.getElementById('stat-total').textContent = counts.total;
  document.getElementById('stat-ok').textContent = counts.authorized;
  document.getElementById('stat-dup').textContent = counts.duplicate;
  document.getElementById('stat-unauth').textContent = counts.unauthorized;
  document.getElementById('stat-exp').textContent = counts.expired;
}

function updateProgress() {
  const total = state.iwrs.size;
  const scanned = state.scanned.filter(p => p.status === 'authorized').length;
  const pct = total > 0 ? Math.min(100, (scanned / total) * 100) : 0;
  document.getElementById('progress-bar').style.width = pct + '%';
}

const STATUS_INFO = {
  authorized:   { icon: 'âœ“', label: 'Authorized' },
  duplicate:    { icon: 'âš ', label: 'Duplicate' },
  unauthorized: { icon: 'âœ•', label: 'Unauthorized' },
  expired:      { icon: '!', label: 'Expired' },
};

function renderScanList() {
  const list = document.getElementById('scan-list');
  if (state.scanned.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><p>No products scanned yet.<br>Point the camera at a label or QR code.</p></div>`;
    return;
  }

  // Show in reverse (newest first)
  list.innerHTML = [...state.scanned].reverse().map((p, ri) => {
    const i = state.scanned.length - 1 - ri;
    const info = STATUS_INFO[p.status] || { icon: '?', label: p.status };
    return `
      <div class="scan-item ${p.status}">
        <div class="scan-item-status">${info.icon}</div>
        <div class="scan-item-info">
          <div class="scan-item-sn">SN: ${p.sn}</div>
          <div class="scan-item-meta">LOT: ${p.lot || 'â€”'} Â· EXP: ${p.exp || 'â€”'} Â· ${info.label}</div>
        </div>
        <button class="scan-item-del" onclick="removeProduct(${i})">ğŸ—‘</button>
      </div>
    `;
  }).join('');
}

function removeProduct(index) {
  state.scanned.splice(index, 1);
  updateStats();
  renderScanList();
  updateProgress();
  toast('Product removed');
}

function showValidationBanner(status, product) {
  const banner = document.getElementById('validation-banner');
  const msgs = {
    authorized:   `âœ“ Authorized â€” SN ${product.sn} confirmed in IWRS`,
    duplicate:    `âš  Duplicate â€” SN ${product.sn} was already scanned`,
    unauthorized: `âœ• Unauthorized â€” SN ${product.sn} not found in IWRS`,
    expired:      `! Expired â€” Product expired ${product.exp}`,
  };
  banner.className = `validation-banner show ${status}`;
  banner.textContent = msgs[status] || status;
  clearTimeout(banner._timeout);
  banner._timeout = setTimeout(() => hideValidationBanner(), 4000);
}

function hideValidationBanner() {
  const banner = document.getElementById('validation-banner');
  banner.classList.remove('show');
}

// â”€â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSummary() {
  const s = state.session;
  document.getElementById('sum-subtitle').textContent =
    `${s.site} Â· ${s.date} Â· ${s.cra}`;

  const counts = { total: state.scanned.length, authorized: 0, duplicate: 0, unauthorized: 0, expired: 0 };
  state.scanned.forEach(p => { if (counts[p.status] !== undefined) counts[p.status]++; });

  document.getElementById('sum-total').textContent = counts.total;
  document.getElementById('sum-ok').textContent = counts.authorized;
  document.getElementById('sum-dup').textContent = counts.duplicate;
  document.getElementById('sum-unauth').textContent = counts.unauthorized;
  document.getElementById('sum-exp').textContent = counts.expired;

  // Scanned table
  const tbody = document.getElementById('sum-tbody');
  tbody.innerHTML = state.scanned.map((p, i) => `
    <tr class="${p.status}">
      <td>${i + 1}</td>
      <td>${p.sn}</td>
      <td>${p.ref || 'â€”'}</td>
      <td>${p.lot || 'â€”'}</td>
      <td>${p.exp || 'â€”'}</td>
      <td><span class="status-badge ${p.status}">${STATUS_INFO[p.status]?.label || p.status}</span></td>
    </tr>
  `).join('');

  // Missing (in IWRS but not scanned)
  const scannedSNs = new Set(state.scanned.map(p => p.sn));
  const snKeys = ['SN', 'sn', 'Serial Number', 'SerialNumber', 'serial_number'];

  const missing = [];
  state.iwrs.forEach((row, sn) => {
    if (!scannedSNs.has(sn)) {
      missing.push({ sn, row });
    }
  });

  if (missing.length > 0) {
    document.getElementById('missing-section').style.display = 'block';
    document.getElementById('missing-count-badge').textContent = `${missing.length} items not returned`;

    const refKeys = ['REF', 'ref', 'Reference'];
    const lotKeys = ['LOT', 'lot', 'LotNumber'];
    const expKeys = ['EXP', 'exp', 'Expiry', 'ExpirationDate'];

    const getVal = (row, keys) => {
      for (const k of keys) if (row[k]) return row[k];
      return 'â€”';
    };

    document.getElementById('missing-tbody').innerHTML = missing.map(({ sn, row }) => `
      <tr class="missing">
        <td>${sn}</td>
        <td>${getVal(row, refKeys)}</td>
        <td>${getVal(row, lotKeys)}</td>
        <td>${getVal(row, expKeys)}</td>
        <td><span class="status-badge missing">Not Returned</span></td>
      </tr>
    `).join('');
  } else {
    document.getElementById('missing-section').style.display = 'none';
  }
}

// â”€â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportExcel() {
  const s = state.session;
  const wb = XLSX.utils.book_new();

  // Sheet 1: Scanned Products
  const scannedData = [
    ['#', 'SN', 'REF', 'PSU', 'LOT', 'EXP', 'Status', 'Timestamp']
  ].concat(state.scanned.map((p, i) => [
    i + 1, p.sn, p.ref || '', p.psu || '', p.lot || '', p.exp || '',
    STATUS_INFO[p.status]?.label || p.status,
    p.timestamp
  ]));

  const ws1 = XLSX.utils.aoa_to_sheet(scannedData);
  ws1['!cols'] = [4, 14, 12, 8, 12, 10, 14, 22].map(w => ({ wch: w }));
  XLSX.utils.book_append_sheet(wb, ws1, 'Scanned Products');

  // Sheet 2: Missing from Scan
  const scannedSNs = new Set(state.scanned.map(p => p.sn));
  const missingRows = [['SN', 'REF', 'LOT', 'EXP', 'Status']];
  state.iwrs.forEach((row, sn) => {
    if (!scannedSNs.has(sn)) {
      const getVal = (keys) => { for (const k of keys) if (row[k]) return row[k]; return ''; };
      missingRows.push([
        sn,
        getVal(['REF', 'ref', 'Reference']),
        getVal(['LOT', 'lot']),
        getVal(['EXP', 'exp', 'Expiry']),
        'Not Returned'
      ]);
    }
  });
  const ws2 = XLSX.utils.aoa_to_sheet(missingRows);
  XLSX.utils.book_append_sheet(wb, ws2, 'Not Returned');

  // Sheet 3: Session Info
  const sessionData = [
    ['Field', 'Value'],
    ['Site', s.site],
    ['Protocol / Study ID', s.protocol || ''],
    ['CRA', s.cra],
    ['Visit Date', s.date],
    ['Export Date', new Date().toISOString()],
    [],
    ['Summary', ''],
    ['Total Scanned', state.scanned.length],
    ['Authorized', state.scanned.filter(p => p.status === 'authorized').length],
    ['Duplicates', state.scanned.filter(p => p.status === 'duplicate').length],
    ['Unauthorized', state.scanned.filter(p => p.status === 'unauthorized').length],
    ['Expired', state.scanned.filter(p => p.status === 'expired').length],
    ['Not Returned (in IWRS)', missingRows.length - 1],
  ];
  const ws3 = XLSX.utils.aoa_to_sheet(sessionData);
  XLSX.utils.book_append_sheet(wb, ws3, 'Session Info');

  const filename = `MedScan_${s.site.replace(/\s+/g, '_')}_${s.date}.xlsx`;
  XLSX.writeFile(wb, filename);
  toast('âœ“ Excel report downloaded');
}

// â”€â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, duration = 2800) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._timeout);
  el._timeout = setTimeout(() => el.classList.remove('show'), duration);
}

function showLoading(msg = 'Processing...') {
  document.getElementById('loading-msg').textContent = msg;
  document.getElementById('loading-overlay').classList.add('show');
}

function hideLoading() {
  document.getElementById('loading-overlay').classList.remove('show');
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate([50]);
}

// â”€â”€â”€ DRAG & DROP for IWRS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uploadZone = document.getElementById('upload-zone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) handleIWRSUpload({ target: { files: [file] } });
});
</script>
</body>
</html>
